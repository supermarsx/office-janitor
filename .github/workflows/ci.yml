# Office Janitor - Unified CI Pipeline
# Rolling releases: YY.X versioning (e.g., 26.1, 26.2, ...)
# Flow: Test → Build → Release → Publish

name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
  workflow_dispatch:
    inputs:
      force_release:
        description: "Force a new rolling release"
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================================================
  # STAGE 1: Quality Checks (parallel)
  # ============================================================================

  format:
    name: Format (Black)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Black
        run: pip install black

      - name: Auto-format with Black
        run: black src tests oj_entry.py

      - name: Check formatting
        run: black --check src tests oj_entry.py

  lint:
    name: Lint (Ruff + MyPy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linters
        run: |
          pip install ruff mypy
          pip install -e .

      - name: Ruff check
        run: ruff check src tests

      - name: MyPy check
        run: mypy --config-file pyproject.toml src

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.11"]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-cov

      - name: Run tests
        run: pytest -q --tb=short

  # ============================================================================
  # STAGE 2: Build (requires all quality checks to pass)
  # ============================================================================

  build:
    name: Build
    runs-on: windows-latest
    needs: [format, lint, test]
    outputs:
      version: ${{ steps.version.outputs.version }}
      exe_hash: ${{ steps.hash.outputs.exe_hash }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for tag counting

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Calculate rolling version (YY.X)
        id: version
        shell: pwsh
        run: |
          $year = (Get-Date).ToString("yy")
          # Count releases this year
          $tags = git tag --list "${year}.*" 2>$null
          if ($tags) {
            $maxRelease = ($tags | ForEach-Object { [int]($_ -split '\.')[-1] } | Measure-Object -Maximum).Maximum
            $release = $maxRelease + 1
          } else {
            $release = 1
          }
          $version = "${year}.${release}"
          Write-Host "Rolling version: $version"
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Install build dependencies
        run: |
          pip install -e .
          pip install pyinstaller build

      - name: Verify OEM files present
        shell: pwsh
        run: |
          Write-Host "=== OEM Files ===" -ForegroundColor Cyan
          Get-ChildItem -Path oem -Recurse | ForEach-Object { Write-Host $_.FullName }
          Write-Host "=== VERSION ===" -ForegroundColor Cyan
          if (Test-Path src/office_janitor/VERSION) { Get-Content src/office_janitor/VERSION }

      - name: Build PyInstaller executable
        shell: pwsh
        run: |
          pyinstaller --clean office-janitor.spec
          Move-Item dist/office-janitor.exe dist/office-janitor.exe -Force -ErrorAction SilentlyContinue
          # Show exe size and bundled oem files
          $exeSize = (Get-Item dist/office-janitor.exe).Length
          Write-Host "EXE Size: $([math]::Round($exeSize / 1MB, 2)) MB"
          Write-Host "=== Bundled OEM files in PKG ===" -ForegroundColor Cyan
          if (Test-Path build/office-janitor/PKG-00.toc) {
            Select-String -Path build/office-janitor/PKG-00.toc -Pattern "oem" | ForEach-Object { Write-Host $_.Line }
          }

      - name: Build Python distributions
        run: python -m build

      - name: Copy config example to dist
        shell: pwsh
        run: |
          Copy-Item config.example.json dist/

      - name: Calculate SHA256 hash
        id: hash
        shell: pwsh
        run: |
          $hash = (Get-FileHash dist/office-janitor.exe -Algorithm SHA256).Hash.ToLower()
          echo "exe_hash=$hash" >> $env:GITHUB_OUTPUT
          echo "SHA256: $hash"

      - name: Generate checksums file
        shell: pwsh
        working-directory: dist
        run: |
          $files = @(
            "office-janitor.exe",
            (Get-ChildItem "*.tar.gz" | Select-Object -First 1).Name,
            (Get-ChildItem "*.whl" | Select-Object -First 1).Name,
            "config.example.json"
          )
          $checksums = foreach ($file in $files) {
            if (Test-Path $file) {
              $hash = (Get-FileHash $file -Algorithm SHA256).Hash.ToLower()
              "$hash  $file"
            }
          }
          $checksums | Out-File -Encoding utf8 checksums.sha256
          Get-Content checksums.sha256

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: office-janitor-build
          path: |
            dist/office-janitor.exe
            dist/*.tar.gz
            dist/*.whl
            dist/config.example.json
            dist/checksums.sha256
          retention-days: 30

  # ============================================================================
  # STAGE 3: Release (on main branch push only)
  # ============================================================================

  release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: office-janitor-build
          path: artifacts/

      - name: Create rolling release tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Rolling release $VERSION"
          git push origin "$VERSION"

      - name: Generate changelog from commits
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            echo "Generating changelog since $PREV_TAG"
            COMMITS=$(git log --pretty=format:"- %s (%h)" "$PREV_TAG"..HEAD)
          else
            echo "No previous tag, using last 150 commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" -150)
          fi

          # Write to output (handle multiline)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.version }}
          name: "Office Janitor ${{ needs.build.outputs.version }}"
          body: |
            ## Rolling Release ${{ needs.build.outputs.version }}

            ### What's Changed
            ${{ steps.changelog.outputs.commits }}

            ### Downloads
            - **Windows executable**: `office-janitor.exe` (portable, no installation required)
            - **Python package**: Available on PyPI (`pip install office-janitor`)
            - **Config template**: `config.example.json`

            ### Installation via Package Managers
            ```powershell
            # Scoop
            scoop bucket add office-janitor https://github.com/${{ github.repository }}
            scoop install office-janitor

            # Winget
            winget install ${{ github.repository_owner }}.office-janitor
            ```

            ### Checksums (SHA256)
            ```
            ${{ needs.build.outputs.exe_hash }}  office-janitor.exe
            ```
          files: |
            artifacts/office-janitor.exe
            artifacts/*.tar.gz
            artifacts/*.whl
            artifacts/config.example.json
            artifacts/checksums.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # STAGE 4: Publish (after release)
  # ============================================================================

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [release, build]
    environment:
      name: pypi
      url: https://pypi.org/p/office-janitor
    permissions:
      id-token: write # Required for trusted publishing
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: office-janitor-build
          path: artifacts/

      - name: Prepare dist for PyPI
        run: |
          mkdir -p dist
          cp artifacts/*.whl artifacts/*.tar.gz dist/ 2>/dev/null || true
          ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true

  update-scoop:
    name: Update Scoop Manifest
    runs-on: ubuntu-latest
    needs: [release, build]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Update Scoop manifest
        env:
          VERSION: ${{ needs.build.outputs.version }}
          EXE_HASH: ${{ needs.build.outputs.exe_hash }}
          REPO: ${{ github.repository }}
        run: |
          cat > bucket/office-janitor.json << EOF
          {
            "\$schema": "https://raw.githubusercontent.com/ScoopInstaller/Scoop/master/schema.json",
            "version": "${VERSION}",
            "description": "Comprehensive Office uninstaller, scrubber, repair and installation tool",
            "homepage": "https://github.com/${REPO}",
            "license": "MIT",
            "architecture": {
              "64bit": {
                "url": "https://github.com/${REPO}/releases/download/${VERSION}/office-janitor.exe",
                "hash": "${EXE_HASH}"
              }
            },
            "bin": "office-janitor.exe",
            "checkver": "github",
            "autoupdate": {
              "architecture": {
                "64bit": {
                  "url": "https://github.com/${REPO}/releases/download/\$version/office-janitor.exe"
                }
              }
            },
            "notes": "Run with administrator privileges: sudo office-janitor"
          }
          EOF

          # Also update config example in bucket
          cp config.example.json bucket/ 2>/dev/null || true

      - name: Commit Scoop manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bucket/
          git diff --staged --quiet || git commit -m "chore: update scoop manifest to ${{ needs.build.outputs.version }}"
          for i in 1 2 3; do
            git fetch origin main
            git rebase origin/main && git push && break
            echo "Retry $i failed, trying again..."
            sleep 2
          done

  update-winget:
    name: Update Winget Manifest
    runs-on: ubuntu-latest
    needs: [release, build]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Update Winget manifests
        env:
          VERSION: ${{ needs.build.outputs.version }}
          EXE_HASH: ${{ needs.build.outputs.exe_hash }}
          REPO: ${{ github.repository }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          WINGET_DIR="winget/${REPO_OWNER}.office-janitor/${VERSION}"
          mkdir -p "$WINGET_DIR"

          # Version manifest
          cat > "${WINGET_DIR}/${REPO_OWNER}.office-janitor.yaml" << EOF
          PackageIdentifier: ${REPO_OWNER}.office-janitor
          PackageVersion: ${VERSION}
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.6.0
          EOF

          # Installer manifest
          cat > "${WINGET_DIR}/${REPO_OWNER}.office-janitor.installer.yaml" << EOF
          PackageIdentifier: ${REPO_OWNER}.office-janitor
          PackageVersion: ${VERSION}
          Platform:
            - Windows.Desktop
          MinimumOSVersion: 10.0.0.0
          InstallerType: portable
          Installers:
            - Architecture: x64
              InstallerUrl: https://github.com/${REPO}/releases/download/${VERSION}/office-janitor.exe
              InstallerSha256: ${EXE_HASH}
              Commands:
                - office-janitor
          ManifestType: installer
          ManifestVersion: 1.6.0
          EOF

          # Locale manifest
          cat > "${WINGET_DIR}/${REPO_OWNER}.office-janitor.locale.en-US.yaml" << EOF
          PackageIdentifier: ${REPO_OWNER}.office-janitor
          PackageVersion: ${VERSION}
          PackageLocale: en-US
          Publisher: ${REPO_OWNER}
          PublisherUrl: https://github.com/${REPO_OWNER}
          PackageName: Office Janitor
          PackageUrl: https://github.com/${REPO}
          License: MIT
          LicenseUrl: https://github.com/${REPO}/blob/main/license.md
          ShortDescription: Comprehensive Office uninstaller, scrubber, repair and installation tool
          Description: |
            Office Janitor is a comprehensive, stdlib-only Python utility for managing Microsoft Office installations on Windows.
            
            Features:
            - Install: Deploy Office using ODT with presets, custom configurations, and live progress monitoring
            - Repair: Quick and full repair for Click-to-Run installations
            - Scrub: Deep uninstall and cleanup of MSI and Click-to-Run Office (2003-2024, Microsoft 365)
          Tags:
            - office
            - microsoft
            - uninstaller
            - cleanup
            - windows
            - admin
          ReleaseNotesUrl: https://github.com/${REPO}/releases/tag/${VERSION}
          ManifestType: defaultLocale
          ManifestVersion: 1.6.0
          EOF

          # Create latest symlink/copy
          rm -rf "winget/${REPO_OWNER}.office-janitor/latest" 2>/dev/null || true
          cp -r "$WINGET_DIR" "winget/${REPO_OWNER}.office-janitor/latest"

      - name: Commit Winget manifests
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add winget/
          git diff --staged --quiet || git commit -m "chore: update winget manifest to ${{ needs.build.outputs.version }}"
          for i in 1 2 3; do
            git fetch origin main
            git rebase origin/main && git push && break
            echo "Retry $i failed, trying again..."
            sleep 2
          done
